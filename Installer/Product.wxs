<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  
  <?define ProductName="FreeWinBackup" ?>
  <?define Manufacturer="FreeWinBackup" ?>
  <?define Version="1.0.0.0" ?>
  <?define UpgradeCode="A1B2C3D4-E5F6-7890-ABCD-EF1234567890" ?>
  
  <!-- Source directory where built application binaries are located -->
  <?define SourceDir="..\FreeWinBackup\bin\Release" ?>
  
  <Product Id="*" 
           Name="$(var.ProductName)" 
           Language="1033" 
           Version="$(var.Version)" 
           Manufacturer="$(var.Manufacturer)" 
           UpgradeCode="$(var.UpgradeCode)">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perUser" 
             Description="$(var.ProductName) Installer"
             Comments="Windows Backup Scheduler Application"
             Manufacturer="$(var.Manufacturer)" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of $(var.ProductName) is already installed." />
    
    <Media Id="1" Cabinet="product.cab" EmbedCab="yes" />

    <!-- Installation scope property - allows switching between per-user and per-machine -->
    <Property Id="INSTALL_SCOPE" Value="perUser" />
    
    <!-- Properties for optional features -->
    <Property Id="AUTOSTART" Value="0" />
    <Property Id="ADDDESKTOPSHORTCUT" Value="0" />
    
    <!-- Main application directory -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder">
        <Directory Id="INSTALLFOLDER" Name="$(var.ProductName)" />
      </Directory>
      
      <!-- Start Menu shortcuts -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="$(var.ProductName)" />
      </Directory>
      
      <!-- Desktop shortcut (optional) -->
      <Directory Id="DesktopFolder" Name="Desktop" />
      
      <!-- Startup folder for auto-start alternative -->
      <Directory Id="StartupFolder" />
    </Directory>

    <!-- Main Feature -->
    <Feature Id="ProductFeature" Title="$(var.ProductName)" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="AutoStartRegistry" />
    </Feature>

    <!-- Component group for main application files -->
    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <!-- Main executable -->
      <Component Id="MainExecutable" Guid="B1C2D3E4-F5A6-4B7C-8D9E-0F1A2B3C4D5E">
        <File Id="FreeWinBackupExe" 
              Name="FreeWinBackup.exe" 
              Source="$(var.SourceDir)\FreeWinBackup.exe" 
              KeyPath="yes" />
      </Component>
      
      <!-- Core library -->
      <Component Id="CoreLibrary" Guid="C2D3E4F5-A6B7-4C8D-9E0F-1A2B3C4D5E6F">
        <File Id="FreeWinBackupCoreDll" 
              Name="FreeWinBackup.Core.dll" 
              Source="$(var.SourceDir)\FreeWinBackup.Core.dll" 
              KeyPath="yes" />
      </Component>
      
      <!-- Configuration file -->
      <Component Id="ConfigFile" Guid="D3E4F5A6-B7C8-4D9E-0F1A-2B3C4D5E6F7A">
        <File Id="AppConfig" 
              Name="FreeWinBackup.exe.config" 
              Source="$(var.SourceDir)\FreeWinBackup.exe.config" 
              KeyPath="yes" />
      </Component>
      
      <!-- Newtonsoft.Json dependency -->
      <Component Id="NewtonsoftJson" Guid="E4F5A6B7-C8D9-4E0F-1A2B-3C4D5E6F7A8B">
        <File Id="NewtonsoftJsonDll" 
              Name="Newtonsoft.Json.dll" 
              Source="$(var.SourceDir)\Newtonsoft.Json.dll" 
              KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <!-- Start Menu Shortcut -->
    <Component Id="ApplicationShortcut" Guid="F5A6B7C8-D9E0-4F1A-2B3C-4D5E6F7A8B9C" Directory="ApplicationProgramsFolder">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="$(var.ProductName)"
                Description="Windows Backup Scheduler Application"
                Target="[#FreeWinBackupExe]"
                WorkingDirectory="INSTALLFOLDER" />
      <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\$(var.Manufacturer)\$(var.ProductName)" Name="installed" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Optional Desktop Shortcut -->
    <Component Id="DesktopShortcut" Guid="A6B7C8D9-E0F1-4A2B-3C4D-5E6F7A8B9C0D" Directory="DesktopFolder">
      <Condition>ADDDESKTOPSHORTCUT = 1</Condition>
      <Shortcut Id="DesktopShortcut"
                Name="$(var.ProductName)"
                Description="Windows Backup Scheduler Application"
                Target="[#FreeWinBackupExe]"
                WorkingDirectory="INSTALLFOLDER" />
      <RegistryValue Root="HKCU" Key="Software\$(var.Manufacturer)\$(var.ProductName)" Name="desktop" Type="integer" Value="1" KeyPath="yes" />
    </Component>

    <!-- Auto-start Registry Entry -->
    <Component Id="AutoStartRegistry" Guid="B7C8D9E0-F1A2-4B3C-4D5E-6F7A8B9C0D1E" Directory="INSTALLFOLDER">
      <Condition>AUTOSTART = 1</Condition>
      <RegistryValue Root="HKCU" 
                     Key="Software\Microsoft\Windows\CurrentVersion\Run" 
                     Name="$(var.ProductName)" 
                     Value="&quot;[#FreeWinBackupExe]&quot; /minimized" 
                     Type="string" 
                     KeyPath="yes" />
    </Component>

    <!-- UI Configuration -->
    <UIRef Id="WixUI_Minimal" />
    <UIRef Id="WixUI_ErrorProgressText" />
    
    <!-- License placeholder -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
    
  </Product>
</Wix>
